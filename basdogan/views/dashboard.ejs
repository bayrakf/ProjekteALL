<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Buchhaltung ‚Äì √úbersicht</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    @media (max-width: 900px) {
      .container { padding: 18px 2vw 18px 2vw; }
      table { font-size: 0.95rem; }
      th, td { padding: 6px 4px; }
    }
    @media (max-width: 600px) {
      .container { padding: 6px 0 6px 0; border-radius: 0; }
      h1, h2 { font-size: 1.2rem; }
      table { min-width: 700px; font-size: 0.89rem; }
      .filter-modal-content { padding: 12px 2vw 12px 2vw !important; }
    }
    @media (max-width: 480px) {
      .container { padding: 0; }
      table { min-width: 500px; }
      th, td { font-size: 0.8rem; }
    }

    /* Premium Hover-Effekte f√ºr Rechnungen-Modal */
    .invoice-row:hover {
      background: rgba(240, 192, 64, 0.1) !important;
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .tab-button:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3) !important;
    }
    
    .btn-pdf:hover {
      background: linear-gradient(135deg, #1d4ed8, #1e3a8a) !important;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4) !important;
    }
    
    .btn-edit-invoice:hover {
      background: linear-gradient(135deg, #059669, #047857) !important;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4) !important;
    }
    
    .btn-delete-invoice:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c) !important;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4) !important;
    }
    
    /* Premium Action Bar Buttons */
    button[onclick="openModal('invoice-new-modal')"]:hover {
      background: linear-gradient(135deg, #059669, #047857) !important;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5) !important;
    }
    
    button[onclick="exportInvoices()"]:hover {
      background: linear-gradient(135deg, #1d4ed8, #1e3a8a) !important;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5) !important;
    }
    
    /* Premium Table Styling */
    .premium-table tbody tr {
      transition: all 0.3s ease;
    }
    
    .premium-table th {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
    }
  </style>
</head>
<body>
  <div class="container" style="max-width:1200px;margin:auto;">
    <nav id="main-nav" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
      <div style="font-size:1.5rem;font-weight:700;letter-spacing:1px;color:#f0c040;">Basdogan Elektrotechnik</div>
      <button id="hamburger" aria-label="Men√º" style="display:none;background:none;border:none;font-size:2.1rem;cursor:pointer;line-height:1;color:#f0c040;">
        &#9776;
      </button>
      <div id="nav-links" style="display:flex;gap:18px;align-items:center;">
        <a href="/" style="background:linear-gradient(135deg, #6366f1, #4f46e5);color:#fff;text-decoration:none;padding:8px 16px;border-radius:8px;font-weight:600;transition:all 0.3s ease;">Zur Landing Page</a>
        <span style="font-size:1rem;color:#fff;">Angemeldet als <b style="color:#f0c040;"><%= user.username %></b></span>
        <a href="/logout" style="padding:8px 18px;border-radius:6px;background:linear-gradient(135deg, #ef4444, #dc2626);color:#fff;font-weight:600;text-decoration:none;transition:all 0.3s ease;">Logout</a>
        <% if(user.username === "admin"){ %>
          <a href="/users" style="padding:8px 18px;border-radius:6px;background:linear-gradient(135deg, #6366f1, #4f46e5);color:#fff;font-weight:600;text-decoration:none;transition:all 0.3s ease;">Benutzerverwaltung</a>
        <% } %>
      </div>
    </nav>

    <script>
      // Hamburger-Men√º f√ºr kleine Bildschirme
      function toggleNav() {
        const nav = document.getElementById('nav-links');
        nav.style.display = nav.style.display === 'flex' ? 'none' : 'flex';
      }
      document.getElementById('hamburger').addEventListener('click', toggleNav);
      function handleResize() {
        const nav = document.getElementById('nav-links');
        const burger = document.getElementById('hamburger');
        if(window.innerWidth < 700) {
          nav.style.display = 'none';
          burger.style.display = 'block';
        } else {
          nav.style.display = 'flex';
          burger.style.display = 'none';
        }
      }
      window.addEventListener('resize', handleResize);
      window.addEventListener('DOMContentLoaded', handleResize);
    </script>

    <% if(error && error.length) { %>
      <p class="error"><%= error %></p>
    <% } %>
    <% if(success && success.length) { %>
      <p class="success"><%= success %></p>
    <% } %>

    <form action="/backup" method="post" style="margin-bottom:18px;display:flex;align-items:center;gap:12px;background:#e0e7ef;padding:10px 18px;border-radius:8px;max-width:420px;">
      <button type="submit" style="padding:8px 18px;border-radius:6px;background:#0ea5e9;color:#fff;font-weight:600;cursor:pointer;">Backup jetzt erstellen</button>
      <span style="font-size:0.95rem;color:#334155;">Automatische t√§gliche Sicherung um 03:00 Uhr</span>
    </form>

    <h2>Neuer Eintrag</h2>
    <form action="/add" method="post" enctype="multipart/form-data">
      <label>Typ:</label>
      <select name="typ" required>
        <option value="Einnahme">Einnahme</option>
        <option value="Ausgabe">Ausgabe</option>
      </select>
      <label>Betrag (‚Ç¨):</label>
      <input type="number" name="betrag" step="0.01" required />
      <label>Beschreibung:</label>
      <input type="text" name="beschreibung" required />
      <label>Firma:</label>
      <input type="text" name="firma" required />
      <label>Kategorie:</label>
      <select name="kategorie" required>
        <option value="Allgemein">Allgemein</option>
        <option value="Miete">Miete</option>
        <option value="Gehalt">Gehalt</option>
        <option value="B√ºrobedarf">B√ºrobedarf</option>
        <option value="Reise">Reise</option>
        <option value="Sonstiges">Sonstiges</option>
      </select>
      <label>Tags (Komma-getrennt):</label>
      <input type="text" name="tags" placeholder="z.B. Steuer, privat" />
      <label>MwSt (%):</label>
      <input type="number" name="mwst_satz" value="20" min="0" max="100" step="0.01" required />
      <label>Wiederkehrend:</label>
      <select name="wiederkehrend">
        <option value="">Keine</option>
        <option value="monatlich">Monatlich</option>
        <option value="jaehrlich">J√§hrlich</option>
      </select>
      <label>Datum:</label>
      <input type="date" name="datum" required />
      <label>Beleg (Foto/PDF):</label>
      <div id="drop-area" style="border:2px dashed #aaa;padding:10px 0 10px 0;margin-bottom:10px;text-align:center;cursor:pointer;background:#f8fafc;">
        <span id="drop-text">Datei hierher ziehen oder klicken</span>
        <input type="file" id="belegInput" name="beleg" accept=".jpg,.jpeg,.png,.pdf" style="display:none;" />
      </div>
      <button type="submit">Speichern</button>
      
      <script>
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('belegInput');
        const dropText = document.getElementById('drop-text');
        dropArea.addEventListener('click', () => fileInput.click());
        dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.style.background='#e0e7ef'; });
        dropArea.addEventListener('dragleave', e => { e.preventDefault(); dropArea.style.background='#f8fafc'; });
        dropArea.addEventListener('drop', e => {
          e.preventDefault();
          dropArea.style.background='#f8fafc';
          if(e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            dropText.textContent = e.dataTransfer.files[0].name;
          }
        });
        fileInput.addEventListener('change', e => {
          if(fileInput.files.length) dropText.textContent = fileInput.files[0].name;
        });
      </script>
    </form>

    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap;gap:10px;">
      <h2 style="margin:0;">Alle Eintr√§ge</h2>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button type="button" onclick="openModal('invoice-new-modal')" style="padding:8px 18px;border-radius:6px;background:#6366f1;color:#fff;font-weight:600;box-shadow:0 2px 8px #6366f133;cursor:pointer;">+ Neue Rechnung/Angebot</button>
        <button type="button" onclick="openModal('invoice-modal')" style="padding:8px 18px;border-radius:6px;background:#0ea5e9;color:#fff;font-weight:600;box-shadow:0 2px 8px #0ea5e933;cursor:pointer;">Rechnungen & Angebote</button>
        <button type="button" onclick="openModal('filter-modal')" style="padding:8px 18px;border-radius:6px;background:#059669;color:#fff;font-weight:600;box-shadow:0 2px 8px #05966933;cursor:pointer;">Filter & Berichte</button>
        <button type="button" onclick="openModal('tax-modal')" style="padding:8px 18px;border-radius:6px;background:#f59e0b;color:#fff;font-weight:600;box-shadow:0 2px 8px #f59e0b33;cursor:pointer;">üìä Steuer-Vorbereitung</button>
        <button type="button" onclick="openModal('crm-modal')" style="padding:8px 18px;border-radius:6px;background:#8b5cf6;color:#fff;font-weight:600;box-shadow:0 2px 8px #8b5cf633;cursor:pointer;">üë• Kundenverwaltung</button>
      </div>
    </div>

    <!-- Premium Finanz-Dashboard -->
    <div style="margin: 24px 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
      <!-- Umsatz-Karte -->
      <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 16px; padding: 24px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <div style="background: linear-gradient(135deg, #22c55e, #16a34a); padding: 12px; border-radius: 12px; font-size: 1.5rem;">üí∞</div>
          <div>
            <h3 style="margin: 0; color: #22c55e; font-size: 1.1rem; font-weight: 700;">Gesamtumsatz</h3>
            <p style="margin: 0; color: #aaa; font-size: 0.9rem;">Alle Einnahmen</p>
          </div>
        </div>
        <div style="font-size: 2rem; font-weight: 800; color: #22c55e; margin-bottom: 8px;" id="total-income">
          <% 
            let totalIncome = 0;
            if(entries && entries.length) {
              totalIncome = entries.filter(e => e.typ === 'Einnahme').reduce((sum, e) => sum + Number(e.betrag || 0), 0);
            }
          %>
          +<%= totalIncome.toFixed(2) %> ‚Ç¨
        </div>
        <div style="color: #aaa; font-size: 0.85rem;">
          <% const incomeCount = entries ? entries.filter(e => e.typ === 'Einnahme').length : 0; %>
          <%= incomeCount %> Einnahmen
        </div>
      </div>

      <!-- Ausgaben-Karte -->
      <div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05)); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 16px; padding: 24px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <div style="background: linear-gradient(135deg, #ef4444, #dc2626); padding: 12px; border-radius: 12px; font-size: 1.5rem;">üí∏</div>
          <div>
            <h3 style="margin: 0; color: #ef4444; font-size: 1.1rem; font-weight: 700;">Gesamtausgaben</h3>
            <p style="margin: 0; color: #aaa; font-size: 0.9rem;">Alle Ausgaben</p>
          </div>
        </div>
        <div style="font-size: 2rem; font-weight: 800; color: #ef4444; margin-bottom: 8px;" id="total-expenses">
          <% 
            let totalExpenses = 0;
            if(entries && entries.length) {
              totalExpenses = entries.filter(e => e.typ === 'Ausgabe').reduce((sum, e) => sum + Number(e.betrag || 0), 0);
            }
          %>
          -<%= totalExpenses.toFixed(2) %> ‚Ç¨
        </div>
        <div style="color: #aaa; font-size: 0.85rem;">
          <% const expenseCount = entries ? entries.filter(e => e.typ === 'Ausgabe').length : 0; %>
          <%= expenseCount %> Ausgaben
        </div>
      </div>

      <!-- Gewinn-Karte -->
      <div style="background: linear-gradient(135deg, rgba(240, 192, 64, 0.1), rgba(240, 192, 64, 0.05)); border: 1px solid rgba(240, 192, 64, 0.3); border-radius: 16px; padding: 24px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <div style="background: linear-gradient(135deg, #f0c040, #d97706); padding: 12px; border-radius: 12px; font-size: 1.5rem;">üìà</div>
          <div>
            <h3 style="margin: 0; color: #f0c040; font-size: 1.1rem; font-weight: 700;">Gewinn/Verlust</h3>
            <p style="margin: 0; color: #aaa; font-size: 0.9rem;">Netto-Ergebnis</p>
          </div>
        </div>
        <div style="font-size: 2rem; font-weight: 800; margin-bottom: 8px;" id="total-profit">
          <% 
            const profit = totalIncome - totalExpenses;
            const profitColor = profit >= 0 ? '#22c55e' : '#ef4444';
            const profitSign = profit >= 0 ? '+' : '';
          %>
          <span style="color: <%= profitColor %>"><%= profitSign %><%= profit.toFixed(2) %> ‚Ç¨</span>
        </div>
        <div style="color: #aaa; font-size: 0.85rem;">
          <% const totalEntries = entries ? entries.length : 0; %>
          <%= totalEntries %> Buchungen insgesamt
        </div>
      </div>

      <!-- Rechnungen-Status-Karte -->
      <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(99, 102, 241, 0.05)); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 16px; padding: 24px; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
          <div style="background: linear-gradient(135deg, #6366f1, #4f46e5); padding: 12px; border-radius: 12px; font-size: 1.5rem;">üìã</div>
          <div>
            <h3 style="margin: 0; color: #6366f1; font-size: 1.1rem; font-weight: 700;">Rechnungen</h3>
            <p style="margin: 0; color: #aaa; font-size: 0.9rem;">Status-√úbersicht</p>
          </div>
        </div>
        <div style="margin-bottom: 8px;">
          <% 
            let invoiceStats = { total: 0, paid: 0, open: 0, cancelled: 0, totalAmount: 0 };
            if(typeof invoices !== 'undefined' && invoices && invoices.length) {
              invoiceStats.total = invoices.length;
              invoiceStats.paid = invoices.filter(inv => inv.status === 'bezahlt').length;
              invoiceStats.open = invoices.filter(inv => inv.status === 'offen').length;
              invoiceStats.cancelled = invoices.filter(inv => inv.status === 'storniert').length;
              invoiceStats.totalAmount = invoices.reduce((sum, inv) => sum + Number(inv.brutto || 0), 0);
            }
          %>
          <div style="font-size: 1.5rem; font-weight: 800; color: #6366f1; margin-bottom: 12px;">
            <%= invoiceStats.total %> Rechnungen
          </div>
          <div style="display: flex; gap: 12px; font-size: 0.85rem;">
            <span style="color: #22c55e;">‚úÖ <%= invoiceStats.paid %> bezahlt</span>
            <span style="color: #f59e0b;">‚è≥ <%= invoiceStats.open %> offen</span>
            <span style="color: #ef4444;">‚ùå <%= invoiceStats.cancelled %> storniert</span>
          </div>
          <div style="color: #aaa; font-size: 0.8rem; margin-top: 8px;">
            Gesamtwert: <%= invoiceStats.totalAmount.toFixed(2) %> ‚Ç¨
          </div>
        </div>
      </div>
    </div>

    <% if(entries && entries.length) { %>
    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>Typ</th>
          <th>Betrag (‚Ç¨)</th>
          <th>Beschreibung</th>
          <th>Firma</th>
          <th>Kategorie</th>
          <th>MwSt (‚Ç¨)</th>
          <th>Netto (‚Ç¨)</th>
          <th>Tags</th>
          <th>Beleg</th>
          <th>Aktion</th>
        </tr>
      </thead>
      <tbody>
        <% entries.forEach(entry => { %>
        <tr>
          <td><%= entry.datum %></td>
          <td style="color:<%= entry.typ === 'Einnahme' ? '#22c55e' : '#ef4444' %>; font-weight: 600;">
            <%= entry.typ %>
          </td>
          <td style="text-align:right; font-weight: 600; color:<%= entry.typ === 'Einnahme' ? '#22c55e' : '#ef4444' %>;">
            <%= entry.typ === 'Einnahme' ? '+' : '-' %><%= Number(entry.betrag).toFixed(2) %>
          </td>
          <td><%= entry.beschreibung %></td>
          <td><%= entry.firma %></td>
          <td><%= entry.kategorie %></td>
          <td style="text-align:right;"><%= Number(entry.mwst_betrag || 0).toFixed(2) %></td>
          <td style="text-align:right;"><%= Number(entry.netto_betrag || entry.betrag).toFixed(2) %></td>
          <td><%= entry.tags || '-' %></td>
          <td>
            <% if(entry.beleg) { %>
              <a href="/beleg/<%= entry.beleg %>" target="_blank" style="color:#3b82f6; text-decoration: none;">üìé Anzeigen</a>
            <% } else { %>
              -
            <% } %>
          </td>
          <td>
            <form action="/delete/<%= entry.id %>" method="post" style="display:inline;" onsubmit="return confirm('Eintrag wirklich l√∂schen?')">
              <button type="submit" style="background:#ef4444; font-size:0.85rem; padding:4px 8px;">L√∂schen</button>
            </form>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>
    <% } else { %>
      <p style="color:#888; padding:24px; text-align:center;">Keine Eintr√§ge vorhanden.</p>
    <% } %>

    <!-- Professional Modal System -->
    <script>
    class ModalManager {
      constructor() {
        this.activeModal = null;
        this.previousFocus = null;
        this.modals = new Map();
        this.setupEventListeners();
      }

      setupEventListeners() {
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.activeModal) {
            this.closeModal(this.activeModal);
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Tab' && this.activeModal) {
            this.trapFocus(e);
          }
        });
      }

      openModal(id) {
        if (this.activeModal) {
          this.closeModal(this.activeModal);
        }

        this.previousFocus = document.activeElement;
        this.activeModal = id;

        const overlay = document.getElementById(`${id}-overlay`);
        const modalEl = document.getElementById(id);

        if (!overlay || !modalEl) {
          console.error(`Modal mit ID ${id} nicht gefunden`);
          return;
        }

        document.body.classList.add('modal-open');
        overlay.classList.add('active');
        modalEl.classList.add('active');

        setTimeout(() => {
          modalEl.focus();
        }, 100);

        modalEl.dispatchEvent(new CustomEvent('modal:open', { detail: { modalId: id } }));
      }

      closeModal(id) {
        if (this.activeModal !== id) return;

        const overlay = document.getElementById(`${id}-overlay`);
        const modalEl = document.getElementById(id);

        if (overlay && modalEl) {
          overlay.classList.remove('active');
          modalEl.classList.remove('active');
        }

        document.body.classList.remove('modal-open');

        if (this.previousFocus) {
          this.previousFocus.focus();
          this.previousFocus = null;
        }

        this.activeModal = null;

        if (modalEl) {
          modalEl.dispatchEvent(new CustomEvent('modal:close', { detail: { modalId: id } }));
        }
      }

      trapFocus(e) {
        if (!this.activeModal) return;

        const modalEl = document.getElementById(this.activeModal);
        const focusableElements = modalEl.querySelectorAll(
          'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
        
        const firstElement = focusableElements[0];
        const lastElement = focusableElements[focusableElements.length - 1];

        if (e.shiftKey) {
          if (document.activeElement === firstElement) {
            lastElement.focus();
            e.preventDefault();
          }
        } else {
          if (document.activeElement === lastElement) {
            firstElement.focus();
            e.preventDefault();
          }
        }
      }

      makeDraggable(modalEl, handle) {
        let isDragging = false;
        let currentX, currentY, initialX, initialY;

        handle.addEventListener('mousedown', dragStart);

        function dragStart(e) {
          initialX = e.clientX - modalEl.offsetLeft;
          initialY = e.clientY - modalEl.offsetTop;

          if (e.target === handle || handle.contains(e.target)) {
            isDragging = true;
            modalEl.classList.add('dragging');
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);
          }
        }

        function drag(e) {
          if (isDragging) {
            e.preventDefault();
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;

            modalEl.style.left = currentX + 'px';
            modalEl.style.top = currentY + 'px';
            modalEl.style.transform = 'none';
          }
        }

        function dragEnd() {
          isDragging = false;
          modalEl.classList.remove('dragging');
          document.removeEventListener('mousemove', drag);
          document.removeEventListener('mouseup', dragEnd);
        }
      }

      makeResizable(modalEl, resizer) {
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
          isResizing = true;
          document.addEventListener('mousemove', resize);
          document.addEventListener('mouseup', stopResize);
        });

        function resize(e) {
          if (!isResizing) return;
          
          const rect = modalEl.getBoundingClientRect();
          const newWidth = e.clientX - rect.left;
          const newHeight = e.clientY - rect.top;

          if (newWidth > 300) {
            modalEl.style.width = newWidth + 'px';
          }
          if (newHeight > 200) {
            modalEl.style.height = newHeight + 'px';
          }
        }

        function stopResize() {
          isResizing = false;
          document.removeEventListener('mousemove', resize);
          document.removeEventListener('mouseup', stopResize);
        }
      }
    }

    const modalManager = new ModalManager();

    function openModal(id) { 
      modalManager.openModal(id); 
    }
    
    function closeModal(id) { 
      modalManager.closeModal(id); 
    }
    </script>

    <!-- MODAL: Neue Rechnung/Angebot -->
    <div class="modal-overlay" id="invoice-new-modal-overlay"></div>
    <div class="modal draggable resizable" id="invoice-new-modal" role="dialog" aria-modal="true" aria-labelledby="invoice-new-title" tabindex="-1" style="width: 700px; height: 600px;">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="invoice-new-title">üìÑ Neue Rechnung / Angebot erstellen</h3>
          <button class="modal-close" onclick="closeModal('invoice-new-modal')" aria-label="Modal schlie√üen">&times;</button>
        </div>
        <div class="modal-resizer"></div>
        <div class="modal-body">
          <form id="invoice-new-form" action="/invoice/new" method="post" onsubmit="return preparePositionen()">
            <label>Typ:</label>
            <select name="typ" required>
              <option value="Rechnung">Rechnung</option>
              <option value="Angebot">Angebot</option>
            </select>
            <label>Empf√§nger:</label>
            <input type="text" name="empfaenger" required />
            <label>Datum:</label>
            <input type="date" name="datum" value="<%= new Date().toISOString().slice(0,10) %>" required />
            <label>F√§llig bis:</label>
            <input type="date" name="faellig" />
            <label>Positionen (Beschreibung, Menge, Einzelpreis):</label>
            <div id="positionen-list-modal">
              <div class="position-row">
                <input type="text" name="pos_beschreibung[]" placeholder="Beschreibung" required style="width:40%" />
                <input type="number" name="pos_menge[]" placeholder="Menge" min="1" value="1" required style="width:15%" />
                <input type="number" name="pos_preis[]" placeholder="Einzelpreis" step="0.01" min="0" required style="width:20%" />
                <button type="button" onclick="removePosModal(this)" style="background:#ef4444; padding:8px 12px; border:none; border-radius:5px; color:#fff; cursor:pointer;">‚Äì</button>
              </div>
            </div>
            <input type="hidden" name="positionen" id="positionen-json-modal" />
            <button type="button" onclick="addPosModal()" style="margin:16px 0;background:linear-gradient(135deg, #10b981, #059669);">+ Position hinzuf√ºgen</button>
            <label>Bemerkung (optional):</label>
            <textarea name="bemerkung" rows="3"></textarea>
            <button type="submit" style="margin-top:20px;width:100%;">üíæ Rechnung/Angebot speichern</button>
          </form>
        </div>
      </div>
    </div>

    <!-- MODAL: Rechnungen & Angebote √úbersicht -->
    <div class="modal-overlay" id="invoice-modal-overlay"></div>
    <div class="modal draggable resizable" id="invoice-modal" role="dialog" aria-modal="true" aria-labelledby="invoice-overview-title" tabindex="-1" style="width: 1000px; height: 700px;">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="invoice-overview-title">üìä Rechnungen & Angebote √úbersicht</h3>
          <button class="modal-close" onclick="closeModal('invoice-modal')" aria-label="Modal schlie√üen">&times;</button>
        </div>
        <div class="modal-resizer"></div>
        <div class="modal-body">
          <!-- Premium Tab Navigation -->
          <div style="display:flex;gap:12px;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid rgba(240, 192, 64, 0.2);">
            <button id="tab-rechnungen" onclick="showInvoicesTab('rechnung')" class="tab-button active" style="background:linear-gradient(135deg, #6366f1, #4f46e5);color:#fff;border:1px solid #6366f1;padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;box-shadow:0 4px 15px rgba(99, 102, 241, 0.3);">
              üìã Rechnungen
            </button>
            <button id="tab-angebote" onclick="showInvoicesTab('angebot')" class="tab-button" style="background:rgba(255, 255, 255, 0.1);color:#f0c040;border:1px solid rgba(240, 192, 64, 0.3);padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;backdrop-filter:blur(10px);">
              üíº Angebote
            </button>
          </div>
          
          <!-- Premium Action Bar -->
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:16px;background:rgba(240, 192, 64, 0.1);border-radius:12px;border:1px solid rgba(240, 192, 64, 0.2);">
            <div style="display:flex;gap:12px;align-items:center;">
              <button onclick="openModal('invoice-new-modal')" style="background:linear-gradient(135deg, #10b981, #059669);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(16, 185, 129, 0.3);display:flex;align-items:center;gap:8px;">
                ‚ûï Neue Rechnung/Angebot
              </button>
              <button onclick="exportInvoices()" style="background:linear-gradient(135deg, #3b82f6, #1d4ed8);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(59, 130, 246, 0.3);display:flex;align-items:center;gap:8px;">
                üìä Exportieren
              </button>
            </div>
            <div style="color:#f0c040;font-size:0.9rem;font-weight:600;">
              <span id="invoice-count">Wird geladen...</span>
            </div>
          </div>
          
          <!-- Premium Table Container -->
          <div style="background:rgba(255, 255, 255, 0.05);border-radius:12px;border:1px solid rgba(240, 192, 64, 0.2);overflow:hidden;box-shadow:0 8px 32px rgba(0, 0, 0, 0.3);">
            <div style="overflow-x:auto;">
              <table id="invoices-table" class="premium-table" style="min-width:900px;width:100%;margin:0;">
                <thead>
                  <tr style="background:linear-gradient(135deg, rgba(240, 192, 64, 0.2), rgba(240, 192, 64, 0.1));">
                    <th style="padding:16px 12px;color:#f0c040;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;">Nr.</th>
                    <th style="padding:16px 12px;color:#f0c040;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;">Typ</th>
                    <th style="padding:16px 12px;color:#f0c040;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;">Empf√§nger</th>
                    <th style="padding:16px 12px;color:#f0c040;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;">Datum</th>
                    <th style="padding:16px 12px;color:#f0c040;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;">F√§llig</th>
                    <th style="padding:16px 12px;color:#f0c040;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;text-align:right;">Netto</th>
                    <th style="padding:16px 12px;color:#f0c040;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;text-align:right;">Brutto</th>
                    <th style="padding:16px 12px;color:#f0c040;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;">Status</th>
                    <th style="padding:16px 12px;color:#f0c040;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;text-align:center;">Aktionen</th>
                  </tr>
                </thead>
                <tbody>
                  <% let hasInvoices = false, hasOffers = false; %>
                  <% if(invoices && invoices.forEach) { %>
                    <% invoices.forEach(inv => { if(inv.typ==='Rechnung') hasInvoices=true; if(inv.typ==='Angebot') hasOffers=true; }) %>
                    <% invoices.forEach(inv => { %>
                    <tr class="invoice-row" data-typ="<%= inv.typ.toLowerCase() %>" style="border-bottom:1px solid rgba(255, 255, 255, 0.1);transition:all 0.3s ease;">
                      <td style="padding:14px 12px;font-family:monospace;color:#fff;font-weight:600;"><%= inv.rechnungsnummer %></td>
                      <td style="padding:14px 12px;color:#fff;"><%= inv.typ %></td>
                      <td style="padding:14px 12px;color:#fff;"><%= inv.empfaenger %></td>
                      <td style="padding:14px 12px;color:#fff;"><%= inv.datum %></td>
                      <td style="padding:14px 12px;color:#fff;"><%= inv.faellig %></td>
                      <td style="padding:14px 12px;text-align:right;color:#fff;font-weight:600;"><%= Number(inv.netto).toFixed(2) %> ‚Ç¨</td>
                      <td style="padding:14px 12px;text-align:right;color:#fff;font-weight:600;"><%= Number(inv.brutto).toFixed(2) %> ‚Ç¨</td>
                      <td style="padding:14px 12px;">
                        <% const bgColor = inv.status === 'bezahlt' ? '#22c55e' : (inv.status === 'storniert' ? '#f87171' : '#fde68a') %>
                        <% const textColor = inv.status === 'bezahlt' ? '#fff' : (inv.status === 'storniert' ? '#fff' : '#b45309') %>
                        <span style="padding:6px 12px;border-radius:8px;font-weight:600;font-size:0.85rem;background:<%= bgColor %>;color:<%= textColor %>;box-shadow:0 2px 8px rgba(0, 0, 0, 0.2);display:inline-block;">
                          <%= inv.status.charAt(0).toUpperCase() + inv.status.slice(1) %>
                        </span>
                      </td>
                      <td style="padding:14px 12px;">
                        <div style="display:flex;gap:8px;align-items:center;justify-content:center;">
                          <button title="PDF anzeigen" class="btn-pdf" data-id="<%= inv.id %>" style="background:linear-gradient(135deg, #3b82f6, #1d4ed8);border:none;color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85em;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(59, 130, 246, 0.3);display:flex;align-items:center;gap:4px;">
                            üìÑ PDF
                          </button>
                          <button title="Bearbeiten" class="btn-edit-invoice" data-id="<%= inv.id %>" style="background:linear-gradient(135deg, #10b981, #059669);border:none;color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85em;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(16, 185, 129, 0.3);display:flex;align-items:center;gap:4px;">
                            ‚úèÔ∏è Bearbeiten
                          </button>
                          <button title="L√∂schen" class="btn-delete-invoice" data-id="<%= inv.id %>" style="background:linear-gradient(135deg, #ef4444, #dc2626);border:none;color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85em;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(239, 68, 68, 0.3);display:flex;align-items:center;gap:4px;">
                            üóëÔ∏è L√∂schen
                          </button>
                        </div>
                      </td>
                    </tr>
                    <% }) %>
                  <% } %>
                </tbody>
              </table>
            </div>
            
            <!-- Empty State Messages -->
            <% if(!hasInvoices) { %>
            <div id="no-rechnungen" style="padding:40px 24px;color:#aaa;text-align:center;background:rgba(255, 255, 255, 0.05);border-top:1px solid rgba(255, 255, 255, 0.1);">
              <div style="font-size:3rem;margin-bottom:16px;opacity:0.5;">üìã</div>
              <h4 style="color:#f0c040;margin:0 0 8px 0;">Keine Rechnungen vorhanden</h4>
              <p style="margin:0;opacity:0.8;">Erstellen Sie Ihre erste Rechnung √ºber den Button oben.</p>
            </div>
            <% } %>
            
            <% if(!hasOffers) { %>
            <div id="no-angebote" style="padding:40px 24px;color:#aaa;text-align:center;background:rgba(255, 255, 255, 0.05);border-top:1px solid rgba(255, 255, 255, 0.1);display:none;">
              <div style="font-size:3rem;margin-bottom:16px;opacity:0.5;">üíº</div>
              <h4 style="color:#f0c040;margin:0 0 8px 0;">Keine Angebote vorhanden</h4>
              <p style="margin:0;opacity:0.8;">Erstellen Sie Ihr erstes Angebot √ºber den Button oben.</p>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: Filter & Berichte -->
    <div class="modal-overlay" id="filter-modal-overlay"></div>
    <div class="modal draggable resizable" id="filter-modal" role="dialog" aria-modal="true" aria-labelledby="filter-title" tabindex="-1" style="width: 800px; height: 600px;">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="filter-title">üîç Filter & Berichte</h3>
          <button class="modal-close" onclick="closeModal('filter-modal')" aria-label="Modal schlie√üen">&times;</button>
        </div>
        <div class="modal-resizer"></div>
        <div class="modal-body">
          <form action="/filter" method="get" class="filter-form-group">
            <div class="filter-form-row">
              <div class="filter-form-col">
                <label>Typ:</label>
                <select name="typ">
                  <option value="">Alle</option>
                  <option value="Einnahme">Einnahme</option>
                  <option value="Ausgabe">Ausgabe</option>
                </select>
              </div>
              <div class="filter-form-col">
                <label>Kategorie:</label>
                <select name="kategorie">
                  <option value="">Alle</option>
                  <option value="Allgemein">Allgemein</option>
                  <option value="Miete">Miete</option>
                  <option value="Gehalt">Gehalt</option>
                  <option value="B√ºrobedarf">B√ºrobedarf</option>
                  <option value="Reise">Reise</option>
                  <option value="Sonstiges">Sonstiges</option>
                </select>
              </div>
            </div>
            <div class="filter-form-row">
              <div class="filter-form-col">
                <label>Von Datum:</label>
                <input type="date" name="von_datum" />
              </div>
              <div class="filter-form-col">
                <label>Bis Datum:</label>
                <input type="date" name="bis_datum" />
              </div>
            </div>
            <div class="filter-form-row">
              <div class="filter-form-col">
                <label>Firma (enth√§lt):</label>
                <input type="text" name="firma" placeholder="Firma suchen..." />
              </div>
              <div class="filter-form-col">
                <label>Beschreibung (enth√§lt):</label>
                <input type="text" name="beschreibung" placeholder="Beschreibung suchen..." />
              </div>
            </div>
            <div class="filter-buttons">
              <button type="submit" class="filter-btn filter-btn-primary">üîç Filter anwenden</button>
              <button type="button" onclick="document.querySelector('#filter-modal form').reset()" class="filter-btn filter-btn-secondary">üóëÔ∏è Zur√ºcksetzen</button>
            </div>
          </form>
          
          <hr style="margin: 32px 0; border: 1px solid rgba(255,255,255,0.1);" />
          
          <div class="filter-form-group">
            <h4 style="color: #f0c040; margin-bottom: 16px;">üìä Berichte erstellen</h4>
            <div class="filter-form-row">
              <div class="filter-form-col">
                <form action="/bericht/monat" method="get" style="margin: 0;">
                  <label>Monatsbericht:</label>
                  <div style="display: flex; gap: 8px; align-items: end;">
                    <input type="month" name="monat" required style="flex: 1;" />
                    <button type="submit" class="filter-btn filter-btn-success">üìÖ Erstellen</button>
                  </div>
                </form>
              </div>
              <div class="filter-form-col">
                <form action="/bericht/jahr" method="get" style="margin: 0;">
                  <label>Jahresbericht:</label>
                  <div style="display: flex; gap: 8px; align-items: end;">
                    <input type="number" name="jahr" min="2020" max="2030" value="<%= new Date().getFullYear() %>" required style="flex: 1;" />
                    <button type="submit" class="filter-btn filter-btn-warning">üìä Erstellen</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: Steuer-Vorbereitung -->
    <div class="modal-overlay" id="tax-modal-overlay"></div>
    <div class="modal draggable resizable" id="tax-modal" role="dialog" aria-modal="true" aria-labelledby="tax-title" tabindex="-1" style="width: 1000px; height: 700px;">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="tax-title">üìä Steuer-Vorbereitung</h3>
          <button class="modal-close" onclick="closeModal('tax-modal')" aria-label="Modal schlie√üen">&times;</button>
        </div>
        <div class="modal-resizer"></div>
        <div class="modal-body">
          <!-- Tab Navigation -->
          <div style="display:flex;gap:12px;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid rgba(240, 192, 64, 0.2);">
            <button id="tab-ust" onclick="showTaxTab('ust')" class="tab-button active" style="background:linear-gradient(135deg, #f59e0b, #d97706);color:#fff;border:1px solid #f59e0b;padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;box-shadow:0 4px 15px rgba(245, 158, 11, 0.3);">
              üìã USt-Voranmeldung
            </button>
            <button id="tab-euer" onclick="showTaxTab('euer')" class="tab-button" style="background:rgba(255, 255, 255, 0.1);color:#f0c040;border:1px solid rgba(240, 192, 64, 0.3);padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;backdrop-filter:blur(10px);">
              üìä E√úR Export
            </button>
            <button id="tab-reports" onclick="showTaxTab('reports')" class="tab-button" style="background:rgba(255, 255, 255, 0.1);color:#f0c040;border:1px solid rgba(240, 192, 64, 0.3);padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;backdrop-filter:blur(10px);">
              üìë Steuerberichte
            </button>
            <button id="tab-datev" onclick="showTaxTab('datev')" class="tab-button" style="background:rgba(255, 255, 255, 0.1);color:#f0c040;border:1px solid rgba(240, 192, 64, 0.3);padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;backdrop-filter:blur(10px);">
              üíæ DATEV Export
            </button>
          </div>

          <!-- USt-Voranmeldung Tab -->
          <div id="tax-content-ust" class="tax-tab-content">
            <div style="background:rgba(245, 158, 11, 0.1);border:1px solid rgba(245, 158, 11, 0.3);border-radius:12px;padding:20px;margin-bottom:20px;">
              <h4 style="color:#f59e0b;margin:0 0 16px 0;font-size:1.2rem;">üè¢ Umsatzsteuer-Voranmeldung</h4>
              
              <!-- Zeitraum-Auswahl -->
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
                <div>
                  <label style="color:#fff;margin-bottom:8px;display:block;font-weight:600;">Voranmeldungszeitraum:</label>
                  <select id="ust-period" style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(245, 158, 11, 0.3);background:rgba(255, 255, 255, 0.1);color:#fff;">
                    <option value="monthly">Monatlich</option>
                    <option value="quarterly">Quartalsweise</option>
                  </select>
                </div>
                <div>
                  <label style="color:#fff;margin-bottom:8px;display:block;font-weight:600;">Zeitraum:</label>
                  <input type="month" id="ust-month" style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(245, 158, 11, 0.3);background:rgba(255, 255, 255, 0.1);color:#fff;" value="<%= new Date().toISOString().slice(0,7) %>">
                </div>
              </div>

              <!-- USt-Berechnung -->
              <div style="background:rgba(255, 255, 255, 0.05);border-radius:10px;padding:20px;">
                <h5 style="color:#f59e0b;margin:0 0 16px 0;">Automatische Berechnung:</h5>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                  <div>
                    <div style="background:rgba(34, 197, 94, 0.1);border:1px solid rgba(34, 197, 94, 0.3);border-radius:8px;padding:16px;margin-bottom:12px;">
                      <div style="color:#22c55e;font-size:0.9rem;margin-bottom:4px;">Ums√§tze 19% USt</div>
                      <div style="font-size:1.3rem;font-weight:700;color:#fff;" id="ust-19-amount">
                        <% 
                          let ust19Amount = 0;
                          if(entries && entries.length) {
                            ust19Amount = entries.filter(e => e.typ === 'Einnahme' && Number(e.mwst_satz || 20) === 19)
                              .reduce((sum, e) => sum + Number(e.netto_betrag || e.betrag || 0), 0);
                          }
                        %>
                        <%= ust19Amount.toFixed(2) %> ‚Ç¨
                      </div>
                      <div style="color:#aaa;font-size:0.8rem;">Netto-Ums√§tze</div>
                    </div>
                    <div style="background:rgba(59, 130, 246, 0.1);border:1px solid rgba(59, 130, 246, 0.3);border-radius:8px;padding:16px;">
                      <div style="color:#3b82f6;font-size:0.9rem;margin-bottom:4px;">Geschuldete USt 19%</div>
                      <div style="font-size:1.3rem;font-weight:700;color:#fff;">
                        <%= (ust19Amount * 0.19).toFixed(2) %> ‚Ç¨
                      </div>
                      <div style="color:#aaa;font-size:0.8rem;">Umsatzsteuer</div>
                    </div>
                  </div>
                  <div>
                    <div style="background:rgba(239, 68, 68, 0.1);border:1px solid rgba(239, 68, 68, 0.3);border-radius:8px;padding:16px;margin-bottom:12px;">
                      <div style="color:#ef4444;font-size:0.9rem;margin-bottom:4px;">Vorsteuer abziehbar</div>
                      <div style="font-size:1.3rem;font-weight:700;color:#fff;" id="vorsteuer-amount">
                        <% 
                          let vorsteuerAmount = 0;
                          if(entries && entries.length) {
                            vorsteuerAmount = entries.filter(e => e.typ === 'Ausgabe')
                              .reduce((sum, e) => sum + Number(e.mwst_betrag || 0), 0);
                          }
                        %>
                        <%= vorsteuerAmount.toFixed(2) %> ‚Ç¨
                      </div>
                      <div style="color:#aaa;font-size:0.8rem;">Gezahlte Vorsteuer</div>
                    </div>
                    <div style="background:rgba(240, 192, 64, 0.1);border:1px solid rgba(240, 192, 64, 0.3);border-radius:8px;padding:16px;">
                      <div style="color:#f0c040;font-size:0.9rem;margin-bottom:4px;">Zahllast / Erstattung</div>
                      <div style="font-size:1.5rem;font-weight:800;color:#f0c040;">
                        <% const zahllast = (ust19Amount * 0.19) - vorsteuerAmount; %>
                        <%= zahllast >= 0 ? '+' : '' %><%= zahllast.toFixed(2) %> ‚Ç¨
                      </div>
                      <div style="color:#aaa;font-size:0.8rem;"><%= zahllast >= 0 ? 'Zu zahlen' : 'Erstattung' %></div>
                    </div>
                  </div>
                </div>
              </div>

              <div style="margin-top:20px;display:flex;gap:12px;">
                <button onclick="generateUStReport()" style="background:linear-gradient(135deg, #f59e0b, #d97706);color:#fff;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(245, 158, 11, 0.3);">
                  üìÑ USt-Voranmeldung erstellen
                </button>
                <button onclick="downloadUStXML()" style="background:linear-gradient(135deg, #6366f1, #4f46e5);color:#fff;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(99, 102, 241, 0.3);">
                  üíæ XML f√ºr ELSTER
                </button>
              </div>
            </div>
          </div>

          <!-- E√úR Export Tab -->
          <div id="tax-content-euer" class="tax-tab-content" style="display:none;">
            <div style="background:rgba(99, 102, 241, 0.1);border:1px solid rgba(99, 102, 241, 0.3);border-radius:12px;padding:20px;">
              <h4 style="color:#6366f1;margin:0 0 16px 0;font-size:1.2rem;">üìä Einnahmen-√úberschuss-Rechnung (E√úR)</h4>
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;">
                <div>
                  <label style="color:#fff;margin-bottom:8px;display:block;font-weight:600;">Wirtschaftsjahr:</label>
                  <input type="number" id="euer-year" min="2020" max="2030" value="<%= new Date().getFullYear() %>" style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(99, 102, 241, 0.3);background:rgba(255, 255, 255, 0.1);color:#fff;">
                </div>
                <div>
                  <label style="color:#fff;margin-bottom:8px;display:block;font-weight:600;">Format:</label>
                  <select id="euer-format" style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(99, 102, 241, 0.3);background:rgba(255, 255, 255, 0.1);color:#fff;">
                    <option value="pdf">PDF-Bericht</option>
                    <option value="excel">Excel-Export</option>
                    <option value="csv">CSV-Datei</option>
                  </select>
                </div>
              </div>

              <!-- E√úR Vorschau -->
              <div style="background:rgba(255, 255, 255, 0.05);border-radius:10px;padding:20px;">
                <h5 style="color:#6366f1;margin:0 0 16px 0;">Jahres√ºbersicht <%= new Date().getFullYear() %>:</h5>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;">
                  <div style="background:rgba(34, 197, 94, 0.1);border:1px solid rgba(34, 197, 94, 0.3);border-radius:8px;padding:16px;text-align:center;">
                    <div style="color:#22c55e;font-size:0.9rem;margin-bottom:8px;">Betriebseinnahmen</div>
                    <div style="font-size:1.5rem;font-weight:700;color:#fff;">
                      <% 
                        let jahresEinnahmen = 0;
                        if(entries && entries.length) {
                          const currentYear = new Date().getFullYear();
                          jahresEinnahmen = entries.filter(e => e.typ === 'Einnahme' && new Date(e.datum).getFullYear() === currentYear)
                            .reduce((sum, e) => sum + Number(e.betrag || 0), 0);
                        }
                      %>
                      <%= jahresEinnahmen.toFixed(2) %> ‚Ç¨
                    </div>
                  </div>
                  <div style="background:rgba(239, 68, 68, 0.1);border:1px solid rgba(239, 68, 68, 0.3);border-radius:8px;padding:16px;text-align:center;">
                    <div style="color:#ef4444;font-size:0.9rem;margin-bottom:8px;">Betriebsausgaben</div>
                    <div style="font-size:1.5rem;font-weight:700;color:#fff;">
                      <% 
                        let jahresAusgaben = 0;
                        if(entries && entries.length) {
                          const currentYear = new Date().getFullYear();
                          jahresAusgaben = entries.filter(e => e.typ === 'Ausgabe' && new Date(e.datum).getFullYear() === currentYear)
                            .reduce((sum, e) => sum + Number(e.betrag || 0), 0);
                        }
                      %>
                      <%= jahresAusgaben.toFixed(2) %> ‚Ç¨
                    </div>
                  </div>
                  <div style="background:rgba(240, 192, 64, 0.1);border:1px solid rgba(240, 192, 64, 0.3);border-radius:8px;padding:16px;text-align:center;">
                    <div style="color:#f0c040;font-size:0.9rem;margin-bottom:8px;">Gewinn/Verlust</div>
                    <div style="font-size:1.5rem;font-weight:700;">
                      <% 
                        const jahresGewinn = jahresEinnahmen - jahresAusgaben;
                        const gewinnColor = jahresGewinn >= 0 ? '#22c55e' : '#ef4444';
                      %>
                      <span style="color:<%= gewinnColor %>"><%= jahresGewinn >= 0 ? '+' : '' %><%= jahresGewinn.toFixed(2) %> ‚Ç¨</span>
                    </div>
                  </div>
                </div>
              </div>

              <div style="margin-top:20px;display:flex;gap:12px;">
                <button onclick="generateEUR()" style="background:linear-gradient(135deg, #6366f1, #4f46e5);color:#fff;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(99, 102, 241, 0.3);">
                  üìä E√úR erstellen
                </button>
                <button onclick="downloadEURExcel()" style="background:linear-gradient(135deg, #10b981, #059669);color:#fff;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(16, 185, 129, 0.3);">
                  üìÅ Excel-Download
                </button>
              </div>
            </div>
          </div>

          <!-- Steuerberichte Tab -->
          <div id="tax-content-reports" class="tax-tab-content" style="display:none;">
            <div style="background:rgba(16, 185, 129, 0.1);border:1px solid rgba(16, 185, 129, 0.3);border-radius:12px;padding:20px;">
              <h4 style="color:#10b981;margin:0 0 16px 0;font-size:1.2rem;">üìë Steuerrelevante Berichte</h4>
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                <div style="background:rgba(255, 255, 255, 0.05);border-radius:10px;padding:20px;">
                  <h5 style="color:#10b981;margin:0 0 16px 0;">üìã Buchf√ºhrungsberichte</h5>
                  <div style="display:flex;flex-direction:column;gap:12px;">
                    <button onclick="generateReport('journal')" style="background:rgba(59, 130, 246, 0.2);border:1px solid rgba(59, 130, 246, 0.3);color:#fff;padding:12px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;">
                      üìî Kassenbuch / Journal
                    </button>
                    <button onclick="generateReport('balances')" style="background:rgba(245, 158, 11, 0.2);border:1px solid rgba(245, 158, 11, 0.3);color:#fff;padding:12px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;">
                      ‚öñÔ∏è Summen- und Saldenliste
                    </button>
                    <button onclick="generateReport('categories')" style="background:rgba(139, 92, 246, 0.2);border:1px solid rgba(139, 92, 246, 0.3);color:#fff;padding:12px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;">
                      üìä Kategorien-Auswertung
                    </button>
                  </div>
                </div>
                
                <div style="background:rgba(255, 255, 255, 0.05);border-radius:10px;padding:20px;">
                  <h5 style="color:#10b981;margin:0 0 16px 0;">üè¢ Steuerauswertungen</h5>
                  <div style="display:flex;flex-direction:column;gap:12px;">
                    <button onclick="generateReport('ust-summary')" style="background:rgba(239, 68, 68, 0.2);border:1px solid rgba(239, 68, 68, 0.3);color:#fff;padding:12px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;">
                      üìÑ USt-Zusammenfassung
                    </button>
                    <button onclick="generateReport('vorsteuer')" style="background:rgba(34, 197, 94, 0.2);border:1px solid rgba(34, 197, 94, 0.3);color:#fff;padding:12px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;">
                      üßæ Vorsteuer-Aufstellung
                    </button>
                    <button onclick="generateReport('reisekosten')" style="background:rgba(168, 85, 247, 0.2);border:1px solid rgba(168, 85, 247, 0.3);color:#fff;padding:12px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;">
                      üöó Reisekosten-Abrechnung
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- DATEV Export Tab -->
          <div id="tax-content-datev" class="tax-tab-content" style="display:none;">
            <div style="background:rgba(168, 85, 247, 0.1);border:1px solid rgba(168, 85, 247, 0.3);border-radius:12px;padding:20px;">
              <h4 style="color:#a855f7;margin:0 0 16px 0;font-size:1.2rem;">üíæ DATEV Export f√ºr Steuerberater</h4>
              
              <div style="background:rgba(255, 255, 255, 0.05);border-radius:10px;padding:20px;margin-bottom:20px;">
                <h5 style="color:#a855f7;margin:0 0 16px 0;">üìã Export-Einstellungen</h5>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                  <div>
                    <label style="color:#fff;margin-bottom:8px;display:block;font-weight:600;">Export-Zeitraum:</label>
                    <select id="datev-period" style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(168, 85, 247, 0.3);background:rgba(255, 255, 255, 0.1);color:#fff;">
                      <option value="month">Aktueller Monat</option>
                      <option value="quarter">Aktuelles Quartal</option>
                      <option value="year">Aktuelles Jahr</option>
                      <option value="custom">Benutzerdefiniert</option>
                    </select>
                  </div>
                  <div>
                    <label style="color:#fff;margin-bottom:8px;display:block;font-weight:600;">Export-Format:</label>
                    <select id="datev-format" style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(168, 85, 247, 0.3);background:rgba(255, 255, 255, 0.1);color:#fff;">
                      <option value="ascii">DATEV ASCII</option>
                      <option value="csv">DATEV CSV</option>
                      <option value="lodas">LODAS Plus</option>
                    </select>
                  </div>
                </div>
              </div>

              <div style="background:rgba(245,  158, 11, 0.1);border:1px solid rgba(245,158, 11, 0.3);border-radius:8px;padding:16px;margin-bottom:20px;">
                <div style="color:#f59e0b;font-weight:600;margin-bottom:8px;">‚ÑπÔ∏è Export-Hinweise:</div>
                <ul style="color:#fff;margin:0;padding-left:20px;line-height:1.6;">
                  <li>Alle Buchungen werden automatisch in DATEV-konforme Formate konvertiert</li>
                  <li>Kontierungsvorschl√§ge basieren auf den eingestellten Kategorien</li>
                  <li>Rechnungsnummern und Belegnummern werden automatisch √ºbernommen</li>
                  <li>Der Export kann direkt an Ihren Steuerberater weitergeleitet werden</li>
                </ul>
              </div>

              <div style="margin-top:20px;display:flex;gap:12px;">
                <button onclick="generateDATEV()" style="background:linear-gradient(135deg, #a855f7, #9333ea);color:#fff;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(168, 85, 247, 0.3);">
                  üíæ DATEV Export erstellen
                </button>
                <button onclick="validateDATEV()" style="background:linear-gradient(135deg, #f59e0b, #d97706);color:#fff;border:none;padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(245, 158, 11, 0.3);">
                  ‚úÖ Export validieren
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: CRM - Kundenverwaltung -->
    <div class="modal-overlay" id="crm-modal-overlay"></div>
    <div class="modal draggable resizable" id="crm-modal" role="dialog" aria-modal="true" aria-labelledby="crm-title" tabindex="-1" style="width: 1200px; height: 800px;">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="crm-title">üë• Erweiterte Kundenverwaltung</h3>
          <button class="modal-close" onclick="closeModal('crm-modal')" aria-label="Modal schlie√üen">&times;</button>
        </div>
        <div class="modal-resizer"></div>
        <div class="modal-body">
          <!-- Tab Navigation -->
          <div style="display:flex;gap:12px;margin-bottom:24px;padding-bottom:16px;border-bottom:1px solid rgba(240, 192, 64, 0.2);">
            <button id="tab-customers" onclick="showCRMTab('customers')" class="tab-button active" style="background:linear-gradient(135deg, #8b5cf6, #7c3aed);color:#fff;border:1px solid #8b5cf6;padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;box-shadow:0 4px 15px rgba(139, 92, 246, 0.3);">
              üë§ Kundenstamm
            </button>
            <button id="tab-analytics" onclick="showCRMTab('analytics')" class="tab-button" style="background:rgba(255, 255, 255, 0.1);color:#f0c040;border:1px solid rgba(240, 192, 64, 0.3);padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;backdrop-filter:blur(10px);">
              üìä Kundenanalyse
            </button>
            <button id="tab-pricing" onclick="showCRMTab('pricing')" class="tab-button" style="background:rgba(255, 255, 255, 0.1);color:#f0c040;border:1px solid rgba(240, 192, 64, 0.3);padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;backdrop-filter:blur(10px);">
              üí∞ Preislisten
            </button>
            <button id="tab-contracts" onclick="showCRMTab('contracts')" class="tab-button" style="background:rgba(255, 255, 255, 0.1);color:#f0c040;border:1px solid rgba(240, 192, 64, 0.3);padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:8px;backdrop-filter:blur(10px);">
              üìã Vertr√§ge
            </button>
          </div>

          <!-- Kundenstamm Tab -->
          <div id="crm-content-customers" class="crm-tab-content">
            <div style="background:rgba(139, 92, 246, 0.1);border:1px solid rgba(139, 92, 246, 0.3);border-radius:12px;padding:20px;margin-bottom:20px;">
              <h4 style="color:#8b5cf6;margin:0 0 16px 0;font-size:1.2rem;">üë§ Kundenstammdaten-Verwaltung</h4>
              
              <!-- Action Bar -->
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:16px;background:rgba(139, 92, 246, 0.1);border-radius:12px;border:1px solid rgba(139, 92, 246, 0.2);">
                <div style="display:flex;gap:12px;align-items:center;">
                  <button onclick="openNewCustomerForm()" style="background:linear-gradient(135deg, #10b981, #059669);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(16, 185, 129, 0.3);display:flex;align-items:center;gap:8px;">
                    ‚ûï Neuer Kunde
                  </button>
                  <button onclick="importCustomers()" style="background:linear-gradient(135deg, #3b82f6, #1d4ed8);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(59, 130, 246, 0.3);display:flex;align-items:center;gap:8px;">
                    üì• Import
                  </button>
                  <input type="text" id="customer-search" placeholder="Kunde suchen..." style="padding:10px 12px;border-radius:8px;border:1px solid rgba(139, 92, 246, 0.3);background:rgba(255, 255, 255, 0.1);color:#fff;width:200px;" onkeyup="searchCustomers()">
                </div>
                <div style="color:#8b5cf6;font-size:0.9rem;font-weight:600;">
                  <span id="customer-count">12 Kunden</span>
                </div>
              </div>

              <!-- Kunden-Tabelle -->
              <div style="background:rgba(255, 255, 255, 0.05);border-radius:12px;border:1px solid rgba(139, 92, 246, 0.2);overflow:hidden;box-shadow:0 8px 32px rgba(0, 0, 0, 0.3);">
                <div style="overflow-x:auto;">
                  <table id="customers-table" class="premium-table" style="min-width:1000px;width:100%;margin:0;">
                    <thead>
                      <tr style="background:linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));">
                        <th style="padding:16px 12px;color:#8b5cf6;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;">Nr.</th>
                        <th style="padding:16px 12px;color:#8b5cf6;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;">Firma</th>
                        <th style="padding:16px 12px;color:#8b5cf6;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;">Ansprechpartner</th>
                        <th style="padding:16px 12px;color:#8b5cf6;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;">Telefon</th>
                        <th style="padding:16px 12px;color:#8b5cf6;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;">Email</th>
                        <th style="padding:16px 12px;color:#8b5cf6;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;text-align:right;">Umsatz</th>
                        <th style="padding:16px 12px;color:#8b5cf6;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;">Status</th>
                        <th style="padding:16px 12px;color:#8b5cf6;font-weight:700;text-transform:uppercase;font-size:0.85rem;letter-spacing:0.5px;text-align:center;">Aktionen</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- Sample Customer Data -->
                      <tr class="customer-row" style="border-bottom:1px solid rgba(255, 255, 255, 0.1);transition:all 0.3s ease;" onmouseover="this.style.background='rgba(139, 92, 246, 0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding:14px 12px;font-family:monospace;color:#fff;font-weight:600;">K001</td>
                        <td style="padding:14px 12px;color:#fff;font-weight:600;">M√ºller Elektro GmbH</td>
                        <td style="padding:14px 12px;color:#fff;">Thomas M√ºller</td>
                        <td style="padding:14px 12px;color:#fff;">+49 30 1234567</td>
                        <td style="padding:14px 12px;color:#3b82f6;">t.mueller@mueller-elektro.de</td>
                        <td style="padding:14px 12px;text-align:right;color:#22c55e;font-weight:600;">15.750,00 ‚Ç¨</td>
                        <td style="padding:14px 12px;">
                          <span style="padding:6px 12px;border-radius:8px;font-weight:600;font-size:0.85rem;background:#22c55e;color:#fff;box-shadow:0 2px 8px rgba(0, 0, 0, 0.2);display:inline-block;">
                            Aktiv
                          </span>
                        </td>
                        <td style="padding:14px 12px;">
                          <div style="display:flex;gap:8px;align-items:center;justify-content:center;">
                            <button title="Profil anzeigen" onclick="viewCustomer('K001')" style="background:linear-gradient(135deg, #3b82f6, #1d4ed8);border:none;color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85em;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(59, 130, 246, 0.3);display:flex;align-items:center;gap:4px;">
                              üëÅÔ∏è Profil
                            </button>
                            <button title="Bearbeiten" onclick="editCustomer('K001')" style="background:linear-gradient(135deg, #10b981, #059669);border:none;color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85em;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(16, 185, 129, 0.3);display:flex;align-items:center;gap:4px;">
                              ‚úèÔ∏è Bearbeiten
                            </button>
                            <button title="Neue Rechnung" onclick="createInvoiceForCustomer('K001')" style="background:linear-gradient(135deg, #f59e0b, #d97706);border:none;color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85em;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(245, 158, 11, 0.3);display:flex;align-items:center;gap:4px;">
                              üìÑ Rechnung
                            </button>
                          </div>
                        </td>
                      </tr>
                      
                      <!-- Weitere Beispiel-Kunden -->
                      <tr class="customer-row" style="border-bottom:1px solid rgba(255, 255, 255, 0.1);transition:all 0.3s ease;" onmouseover="this.style.background='rgba(139, 92, 246, 0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding:14px 12px;font-family:monospace;color:#fff;font-weight:600;">K002</td>
                        <td style="padding:14px 12px;color:#fff;font-weight:600;">Schmidt Installations-Service</td>
                        <td style="padding:14px 12px;color:#fff;">Anna Schmidt</td>
                        <td style="padding:14px 12px;color:#fff;">+49 40 9876543</td>
                        <td style="padding:14px 12px;color:#3b82f6;">a.schmidt@schmidt-service.de</td>
                        <td style="padding:14px 12px;text-align:right;color:#22c55e;font-weight:600;">8.950,00 ‚Ç¨</td>
                        <td style="padding:14px 12px;">
                          <span style="padding:6px 12px;border-radius:8px;font-weight:600;font-size:0.85rem;background:#f59e0b;color:#fff;box-shadow:0 2px 8px rgba(0, 0, 0, 0.2);display:inline-block;">
                            Wartung
                          </span>
                        </td>
                        <td style="padding:14px 12px;">
                          <div style="display:flex;gap:8px;align-items:center;justify-content:center;">
                            <button title="Profil anzeigen" onclick="viewCustomer('K002')" style="background:linear-gradient(135deg, #3b82f6, #1d4ed8);border:none;color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85em;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(59, 130, 246, 0.3);display:flex;align-items:center;gap:4px;">
                              üëÅÔ∏è Profil
                            </button>
                            <button title="Bearbeiten" onclick="editCustomer('K002')" style="background:linear-gradient(135deg, #10b981, #059669);border:none;color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85em;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(16, 185, 129, 0.3);display:flex;align-items:center;gap:4px;">
                              ‚úèÔ∏è Bearbeiten
                            </button>
                            <button title="Neue Rechnung" onclick="createInvoiceForCustomer('K002')" style="background:linear-gradient(135deg, #f59e0b, #d97706);border:none;color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85em;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(245, 158, 11, 0.3);display:flex;align-items:center;gap:4px;">
                              üìÑ Rechnung
                            </button>
                          </div>
                        </td>
                      </tr>
                      
                      <tr class="customer-row" style="border-bottom:1px solid rgba(255, 255, 255, 0.1);transition:all 0.3s ease;" onmouseover="this.style.background='rgba(139, 92, 246, 0.1)'" onmouseout="this.style.background='transparent'">
                        <td style="padding:14px 12px;font-family:monospace;color:#fff;font-weight:600;">K003</td>
                        <td style="padding:14px 12px;color:#fff;font-weight:600;">Weber Bauunternehmen</td>
                        <td style="padding:14px 12px;color:#fff;">Klaus Weber</td>
                        <td style="padding:14px 12px;color:#fff;">+49 89 5551234</td>
                        <td style="padding:14px 12px;color:#3b82f6;">k.weber@weber-bau.de</td>
                        <td style="padding:14px 12px;text-align:right;color:#22c55e;font-weight:600;">25.300,00 ‚Ç¨</td>
                        <td style="padding:14px 12px;">
                          <span style="padding:6px 12px;border-radius:8px;font-weight:600;font-size:0.85rem;background:#22c55e;color:#fff;box-shadow:0 2px 8px rgba(0, 0, 0, 0.2);display:inline-block;">
                            Premium
                          </span>
                        </td>
                        <td style="padding:14px 12px;">
                          <div style="display:flex;gap:8px;align-items:center;justify-content:center;">
                            <button title="Profil anzeigen" onclick="viewCustomer('K003')" style="background:linear-gradient(135deg, #3b82f6, #1d4ed8);border:none;color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85em;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(59, 130, 246, 0.3);display:flex;align-items:center;gap:4px;">
                              üëÅÔ∏è Profil
                            </button>
                            <button title="Bearbeiten" onclick="editCustomer('K003')" style="background:linear-gradient(135deg, #10b981, #059669);border:none;color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85em;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(16, 185, 129, 0.3);display:flex;align-items:center;gap:4px;">
                              ‚úèÔ∏è Bearbeiten
                            </button>
                            <button title="Neue Rechnung" onclick="createInvoiceForCustomer('K003')" style="background:linear-gradient(135deg, #f59e0b, #d97706);border:none;color:#fff;padding:8px 12px;border-radius:6px;font-size:0.85em;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(245, 158, 11, 0.3);display:flex;align-items:center;gap:4px;">
                              üìÑ Rechnung
                            </button>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Kundenanalyse Tab -->
          <div id="crm-content-analytics" class="crm-tab-content" style="display:none;">
            <div style="background:rgba(59, 130, 246, 0.1);border:1px solid rgba(59, 130, 246, 0.3);border-radius:12px;padding:20px;">
              <h4 style="color:#3b82f6;margin:0 0 16px 0;font-size:1.2rem;">üìä Kundenanalyse & Statistiken</h4>
              
              <!-- Analytics Dashboard -->
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:24px;">
                <div style="background:rgba(34, 197, 94, 0.1);border:1px solid rgba(34, 197, 94, 0.3);border-radius:12px;padding:20px;text-align:center;">
                  <div style="font-size:2rem;margin-bottom:8px;">üë•</div>
                  <div style="color:#22c55e;font-size:0.9rem;margin-bottom:8px;">Aktive Kunden</div>
                  <div style="font-size:2rem;font-weight:800;color:#fff;">12</div>
                  <div style="color:#aaa;font-size:0.8rem;">+2 diesen Monat</div>
                </div>
                
                <div style="background:rgba(245, 158, 11, 0.1);border:1px solid rgba(245, 158, 11, 0.3);border-radius:12px;padding:20px;text-align:center;">
                  <div style="font-size:2rem;margin-bottom:8px;">üí∞</div>
                  <div style="color:#f59e0b;font-size:0.9rem;margin-bottom:8px;">Durchschnittsumsatz</div>
                  <div style="font-size:2rem;font-weight:800;color:#fff;">16.667 ‚Ç¨</div>
                  <div style="color:#aaa;font-size:0.8rem;">pro Kunde/Jahr</div>
                </div>
                
                <div style="background:rgba(139, 92, 246, 0.1);border:1px solid rgba(139, 92, 246, 0.3);border-radius:12px;padding:20px;text-align:center;">
                  <div style="font-size:2rem;margin-bottom:8px;">üìà</div>
                  <div style="color:#8b5cf6;font-size:0.9rem;margin-bottom:8px;">Kundenwachstum</div>
                  <div style="font-size:2rem;font-weight:800;color:#fff;">+20%</div>
                  <div style="color:#aaa;font-size:0.8rem;">gegen√ºber Vorjahr</div>
                </div>
              </div>

              <!-- Top Kunden -->
              <div style="background:rgba(255, 255, 255, 0.05);border-radius:12px;padding:20px;margin-bottom:20px;">
                <h5 style="color:#3b82f6;margin:0 0 16px 0;">üèÜ Top-Kunden (Umsatz)</h5>
                <div style="display:flex;flex-direction:column;gap:12px;">
                  <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(34, 197, 94, 0.1);border-radius:6px;">
                    <span style="color:#fff;font-weight:600;">ü•á Weber Bauunternehmen</span>
                    <span style="color:#22c55e;font-weight:700;">25.300 ‚Ç¨</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(245, 158, 11, 0.1);border-radius:6px;">
                    <span style="color:#fff;font-weight:600;">ü•à M√ºller Elektro GmbH</span>
                    <span style="color:#f59e0b;font-weight:700;">15.750 ‚Ç¨</span>
                  </div>
                  <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(239, 68, 68, 0.1);border-radius:6px;">
                    <span style="color:#fff;font-weight:600;">ü•â Schmidt Installations-Service</span>
                    <span style="color:#ef4444;font-weight:700;">8.950 ‚Ç¨</span>
                  </div>
                </div>
              </div>

              <!-- Aktivit√§ts-Timeline -->
              <div style="background:rgba(255, 255, 255, 0.05);border-radius:12px;padding:20px;">
                <h5 style="color:#3b82f6;margin:0 0 16px 0;">üìÖ Letzte Aktivit√§ten</h5>
                <div style="display:flex;flex-direction:column;gap:12px;">
                  <div style="display:flex;gap:12px;padding:12px;background:rgba(139, 92, 246, 0.1);border-radius:8px;">
                    <div style="color:#8b5cf6;font-weight:600;">üìÑ</div>
                    <div>
                      <div style="color:#fff;font-weight:600;">Rechnung RECH-2025-001 erstellt</div>
                      <div style="color:#aaa;font-size:0.8rem;">Weber Bauunternehmen ‚Ä¢ vor 2 Stunden</div>
                    </div>
                  </div>
                  <div style="display:flex;gap:12px;padding:12px;background:rgba(34, 197, 94, 0.1);border-radius:8px;">
                    <div style="color:#22c55e;font-weight:600;">üí∞</div>
                    <div>
                      <div style="color:#fff;font-weight:600;">Zahlung erhalten: 5.750 ‚Ç¨</div>
                      <div style="color:#aaa;font-size:0.8rem;">M√ºller Elektro GmbH ‚Ä¢ vor 1 Tag</div>
                    </div>
                  </div>
                  <div style="display:flex;gap:12px;padding:12px;background:rgba(59, 130, 246, 0.1);border-radius:8px;">
                    <div style="color:#3b82f6;font-weight:600;">üë§</div>
                    <div>
                      <div style="color:#fff;font-weight:600;">Neuer Kunde registriert</div>
                      <div style="color:#aaa;font-size:0.8rem;">Fischer Elektrotechnik ‚Ä¢ vor 3 Tagen</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Preislisten Tab -->
          <div id="crm-content-pricing" class="crm-tab-content" style="display:none;">
            <div style="background:rgba(245, 158, 11, 0.1);border:1px solid rgba(245, 158, 11, 0.3);border-radius:12px;padding:20px;">
              <h4 style="color:#f59e0b;margin:0 0 16px 0;font-size:1.2rem;">üí∞ Individuelle Preislisten & Konditionen</h4>
              
              <div style="display:flex;gap:12px;margin-bottom:20px;">
                <button onclick="createPriceList()" style="background:linear-gradient(135deg, #10b981, #059669);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(16, 185, 129, 0.3);">
                  ‚ûï Neue Preisliste
                </button>
                <button onclick="importPrices()" style="background:linear-gradient(135deg, #3b82f6, #1d4ed8);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(59, 130, 246, 0.3);">
                  üì• Import
                </button>
              </div>

              <!-- Preislisten-√úbersicht -->
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                <div style="background:rgba(255, 255, 255, 0.05);border-radius:12px;padding:20px;">
                  <h5 style="color:#f59e0b;margin:0 0 16px 0;">üìã Standard-Preisliste</h5>
                  <div style="display:flex;flex-direction:column;gap:8px;">
                    <div style="display:flex;justify-content:space-between;padding:8px;background:rgba(245, 158, 11, 0.1);border-radius:6px;">
                      <span style="color:#fff;">Elektroinstallation</span>
                      <span style="color:#f59e0b;font-weight:600;">65,00 ‚Ç¨/h</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px;background:rgba(245, 158, 11, 0.1);border-radius:6px;">
                      <span style="color:#fff;">Wartungsarbeiten</span>
                      <span style="color:#f59e0b;font-weight:600;">55,00 ‚Ç¨/h</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px;background:rgba(245, 158, 11, 0.1);border-radius:6px;">
                      <span style="color:#fff;">Notdienst</span>
                      <span style="color:#f59e0b;font-weight:600;">85,00 ‚Ç¨/h</span>
                    </div>
                  </div>
                </div>

                <div style="background:rgba(255, 255, 255, 0.05);border-radius:12px;padding:20px;">
                  <h5 style="color:#f59e0b;margin:0 0 16px 0;">üèÜ Premium-Kunden</h5>
                  <div style="display:flex;flex-direction:column;gap:8px;">
                    <div style="display:flex;justify-content:space-between;padding:8px;background:rgba(34, 197, 94, 0.1);border-radius:6px;">
                      <span style="color:#fff;">Elektroinstallation</span>
                      <span style="color:#22c55e;font-weight:600;">58,50 ‚Ç¨/h (-10%)</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px;background:rgba(34, 197, 94, 0.1);border-radius:6px;">
                      <span style="color:#fff;">Wartungsarbeiten</span>
                      <span style="color:#22c55e;font-weight:600;">49,50 ‚Ç¨/h (-10%)</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:8px;background:rgba(34, 197, 94, 0.1);border-radius:6px;">
                      <span style="color:#fff;">Notdienst</span>
                      <span style="color:#22c55e;font-weight:600;">76,50 ‚Ç¨/h (-10%)</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Vertr√§ge Tab -->
          <div id="crm-content-contracts" class="crm-tab-content" style="display:none;">
            <div style="background:rgba(34, 197, 94, 0.1);border:1px solid rgba(34, 197, 94, 0.3);border-radius:12px;padding:20px;">
              <h4 style="color:#22c55e;margin:0 0 16px 0;font-size:1.2rem;">üìã Wartungsvertr√§ge & Abonnements</h4>
              
              <div style="display:flex;gap:12px;margin-bottom:20px;">
                <button onclick="createContract()" style="background:linear-gradient(135deg, #10b981, #059669);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(16, 185, 129, 0.3);">
                  ‚ûï Neuer Vertrag
                </button>
                <button onclick="renewContracts()" style="background:linear-gradient(135deg, #f59e0b, #d97706);color:#fff;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(245, 158, 11, 0.3);">
                  üîÑ Verl√§ngerungen
                </button>
              </div>

              <!-- Aktive Vertr√§ge -->
              <div style="background:rgba(255, 255, 255, 0.05);border-radius:12px;padding:20px;">
                <h5 style="color:#22c55e;margin:0 0 16px 0;">üìÑ Aktive Wartungsvertr√§ge</h5>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                  <div style="background:rgba(34, 197, 94, 0.1);border:1px solid rgba(34, 197, 94, 0.3);border-radius:8px;padding:16px;">
                    <div style="color:#fff;font-weight:600;margin-bottom:8px;">Weber Bauunternehmen</div>
                    <div style="color:#22c55e;font-size:0.9rem;margin-bottom:8px;">Wartungsvertrag Premium</div>
                    <div style="color:#aaa;font-size:0.8rem;margin:8px 0;">Laufzeit: 01.01.2025 - 31.12.2025</div>
                    <div style="color:#f59e0b;font-weight:600;">2.400 ‚Ç¨/Jahr</div>
                  </div>
                  
                  <div style="background:rgba(59, 130, 246, 0.1);border:1px solid rgba(59, 130, 246, 0.3);border-radius:8px;padding:16px;">
                    <div style="color:#fff;font-weight:600;margin-bottom:8px;">Schmidt Installations-Service</div>
                    <div style="color:#3b82f6;font-size:0.9rem;margin-bottom:8px;">Wartungsvertrag Standard</div>
                    <div style="color:#aaa;font-size:0.8rem;margin:8px 0;">Laufzeit: 15.03.2025 - 14.03.2026</div>
                    <div style="color:#f59e0b;font-weight:600;">1.200 ‚Ç¨/Jahr</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: Rechnung/Angebot bearbeiten -->
    <div class="modal-overlay" id="edit-invoice-modal-overlay"></div>
    <div class="modal" id="edit-invoice-modal">
      <div class="modal-header">
        <h3>Rechnung/Angebot bearbeiten</h3>
        <button class="modal-close" onclick="closeModal('edit-invoice-modal')">√ó</button>
        <div class="modal-resizer"></div>
      </div>
      <div class="modal-content">
        <form onsubmit="event.preventDefault(); saveEditInvoice();">
          <input type="hidden" id="edit-invoice-id" />
          
          <label>Typ:</label>
          <select id="edit-typ" required>
            <option value="Rechnung">Rechnung</option>
            <option value="Angebot">Angebot</option>
          </select>
          
          <label>Empf√§nger:</label>
          <input type="text" id="edit-empfaenger" required />
          
          <label>Datum:</label>
          <input type="date" id="edit-datum" required />
          
          <label>F√§llig bis:</label>
          <input type="date" id="edit-faellig" />
          
          <label>Positionen:</label>
          <div id="edit-positionen-list">
            <!-- Positionen werden hier dynamisch eingef√ºgt -->
          </div>
          <button type="button" onclick="addEditPos()" style="margin:10px 0;">+ Position</button>
          
          <label>Bemerkung:</label>
          <textarea id="edit-bemerkung" rows="2"></textarea>
          
          <button type="submit" style="margin-top:18px;">Speichern</button>
        </form>
      </div>
    </div>

    <script>
    // Initialisiere Modal-System
    document.addEventListener('DOMContentLoaded', function() {
      // Mache Modals draggable und resizable
      modalManager.makeDraggable(
        document.getElementById('invoice-new-modal'),
        document.querySelector('#invoice-new-modal .modal-header')
      );
      
      modalManager.makeResizable(
        document.getElementById('invoice-new-modal'),
        document.querySelector('#invoice-new-modal .modal-resizer')
      );

      modalManager.makeDraggable(
        document.getElementById('invoice-modal'),
        document.querySelector('#invoice-modal .modal-header')
      );
      
      modalManager.makeResizable(
        document.getElementById('invoice-modal'),
        document.querySelector('#invoice-modal .modal-resizer')
      );

      modalManager.makeDraggable(
        document.getElementById('filter-modal'),
        document.querySelector('#filter-modal .modal-header')
      );
      
      modalManager.makeResizable(
        document.getElementById('filter-modal'),
        document.querySelector('#filter-modal .modal-resizer')
      );

      modalManager.makeDraggable(
        document.getElementById('tax-modal'),
        document.querySelector('#tax-modal .modal-header')
      );
      
      modalManager.makeResizable(
        document.getElementById('tax-modal'),
        document.querySelector('#tax-modal .modal-resizer')
      );

      modalManager.makeDraggable(
        document.getElementById('crm-modal'),
        document.querySelector('#crm-modal .modal-header')
      );
      
      modalManager.makeResizable(
        document.getElementById('crm-modal'),
        document.querySelector('#crm-modal .modal-resizer')
      );

      modalManager.makeDraggable(
        document.getElementById('edit-invoice-modal'),
        document.querySelector('#edit-invoice-modal .modal-header')
      );
      
      modalManager.makeResizable(
        document.getElementById('edit-invoice-modal'),
        document.querySelector('#edit-invoice-modal .modal-resizer')
      );

      // Setup Event-Listeners f√ºr Overlay-Clicks
      document.getElementById('invoice-new-modal-overlay').addEventListener('click', function(e) {
        if (e.target === this) closeModal('invoice-new-modal');
      });

      document.getElementById('invoice-modal-overlay').addEventListener('click', function(e) {
        if (e.target === this) closeModal('invoice-modal');
      });

      document.getElementById('filter-modal-overlay').addEventListener('click', function(e) {
        if (e.target === this) closeModal('filter-modal');
      });

      document.getElementById('tax-modal-overlay').addEventListener('click', function(e) {
        if (e.target === this) closeModal('tax-modal');
      });

      document.getElementById('crm-modal-overlay').addEventListener('click', function(e) {
        if (e.target === this) closeModal('crm-modal');
      });

      document.getElementById('edit-invoice-modal-overlay').addEventListener('click', function(e) {
        if (e.target === this) closeModal('edit-invoice-modal');
      });

      // ...existing code...
    });

    // Modal-Formular: Positionen dynamisch
    function addPosModal() {
      const row = document.createElement('div');
      row.className = 'position-row';
      row.innerHTML = `<input type="text" name="pos_beschreibung[]" placeholder="Beschreibung" required style="width:40%" />
        <input type="number" name="pos_menge[]" placeholder="Menge" min="1" value="1" required style="width:15%" />
        <input type="number" name="pos_preis[]" placeholder="Einzelpreis" step="0.01" min="0" required style="width:20%" />
        <button type="button" onclick="removePosModal(this)" style="background:#ef4444; padding:8px 12px; border:none; border-radius:5px; color:#fff; cursor:pointer;">‚Äì</button>`;
      document.getElementById('positionen-list-modal').appendChild(row);
    }

    function removePosModal(btn) {
      btn.parentNode.remove();
    }

    function preparePositionen() {
      const beschreibungen = Array.from(document.querySelectorAll('#positionen-list-modal [name="pos_beschreibung[]"]')).map(e => e.value.trim());
      const mengen = Array.from(document.querySelectorAll('#positionen-list-modal [name="pos_menge[]"]')).map(e => e.value);
      const preise = Array.from(document.querySelectorAll('#positionen-list-modal [name="pos_preis[]"]')).map(e => e.value);
      const posArr = [];
      for (let i = 0; i < beschreibungen.length; i++) {
        if (beschreibungen[i] && mengen[i] && preise[i]) {
          posArr.push({ beschreibung: beschreibungen[i], menge: mengen[i], preis: preise[i] });
        }
      }
      document.getElementById('positionen-json-modal').value = JSON.stringify(posArr);
      return true;
    }

    function showInvoicesTab(tab) {
      const rows = document.querySelectorAll('.invoice-row');
      const btnRe = document.getElementById('tab-rechnungen');
      const btnAn = document.getElementById('tab-angebote');
      let hasVisible = false;
      let visibleCount = 0;
      
      rows.forEach(r => {
        if(r.dataset.typ === tab) {
          r.style.display = '';
          hasVisible = true;
          visibleCount++;
        } else {
          r.style.display = 'none';
        }
      });
      
      const noRechnungen = document.getElementById('no-rechnungen');
      const noAngebote = document.getElementById('no-angebote');
      
      if (noRechnungen) noRechnungen.style.display = (tab==='rechnung' && !hasVisible) ? '' : 'none';
      if (noAngebote) noAngebote.style.display = (tab==='angebot' && !hasVisible) ? '' : 'none';
      
      // Premium Tab-Styling
      if (btnRe && btnAn) {
        if (tab === 'rechnung') {
          btnRe.style.background = 'linear-gradient(135deg, #6366f1, #4f46e5)';
          btnRe.style.color = '#fff';
          btnRe.style.borderColor = '#6366f1';
          btnRe.style.boxShadow = '0 4px 15px rgba(99, 102, 241, 0.3)';
          btnRe.classList.add('active');
          
          btnAn.style.background = 'rgba(255, 255, 255, 0.1)';
          btnAn.style.color = '#f0c040';
          btnAn.style.borderColor = 'rgba(240, 192, 64, 0.3)';
          btnAn.style.boxShadow = 'none';
          btnAn.classList.remove('active');
        } else {
          btnAn.style.background = 'linear-gradient(135deg, #6366f1, #4f46e5)';
          btnAn.style.color = '#fff';
          btnAn.style.borderColor = '#6366f1';
          btnAn.style.boxShadow = '0 4px 15px rgba(99, 102, 241, 0.3)';
          btnAn.classList.add('active');
          
          btnRe.style.background = 'rgba(255, 255, 255, 0.1)';
          btnRe.style.color = '#f0c040';
          btnRe.style.borderColor = 'rgba(240, 192, 64, 0.3)';
          btnRe.style.boxShadow = 'none';
          btnRe.classList.remove('active');
        }
      }
      
      // Update Counter
      const counter = document.getElementById('invoice-count');
      if (counter) {
        const typ = tab === 'rechnung' ? 'Rechnungen' : 'Angebote';
        counter.textContent = `${visibleCount} ${typ} gefunden`;
      }
    }

    // Steuer-Modal Funktionen
    function showTaxTab(tabName) {
      // Alle Tabs verstecken
      document.querySelectorAll('.tax-tab-content').forEach(tab => {
        tab.style.display = 'none';
      });
      
      // Alle Tab-Buttons deaktivieren
      document.querySelectorAll('#tax-modal .tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'rgba(255, 255, 255, 0.1)';
        btn.style.color = '#f0c040';
      });
      
      // Aktiven Tab anzeigen
      document.getElementById(`tax-content-${tabName}`).style.display = 'block';
      
      // Aktiven Button stylen
      const activeButton = document.getElementById(`tab-${tabName}`);
      if (activeButton) {
        activeButton.classList.add('active');
        activeButton.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
        activeButton.style.color = '#fff';
      }
    }

    // Kunden-Modal Funktionen
    function showCRMTab(tabName) {
      // Alle Tabs verstecken
      document.querySelectorAll('.crm-tab-content').forEach(tab => {
        tab.style.display = 'none';
      });
      
      // Alle Tab-Buttons deaktivieren
      document.querySelectorAll('#crm-modal .tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'rgba(255, 255, 255, 0.1)';
        btn.style.color = '#f0c040';
      });
      
      // Aktiven Tab anzeigen
      document.getElementById(`crm-content-${tabName}`).style.display = 'block';
      
      // Aktiven Button stylen
      const activeButton = document.getElementById(`tab-${tabName}`);
      if (activeButton) {
        activeButton.classList.add('active');
        activeButton.style.background = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
        activeButton.style.color = '#fff';
      }
    }

    // Setup Event-Handler f√ºr Rechnungs√ºbersicht-Aktionen
    function setupInvoiceTableActions() {
      console.log('Setting up invoice table actions...');
      
      // Event-Delegation f√ºr dynamisch geladene Buttons
      document.addEventListener('click', function(e) {
        console.log('Click detected on:', e.target);
        
        // PDF-Button
        if (e.target.closest('.btn-pdf')) {
          e.preventDefault();
          const btn = e.target.closest('.btn-pdf');
          const id = btn.dataset.id;
          console.log('PDF button clicked for ID:', id);
          if (id) {
            window.open(`/invoice/${id}/pdf`, '_blank');
          }
          return;
        }
        
        // Bearbeiten-Button
        if (e.target.closest('.btn-edit-invoice')) {
          e.preventDefault();
          const btn = e.target.closest('.btn-edit-invoice');
          const id = btn.dataset.id;
          console.log('Edit button clicked for ID:', id);
          if (id) {
            editInvoice(id);
          }
          return;
        }
        
        // L√∂schen-Button
        if (e.target.closest('.btn-delete-invoice')) {
          e.preventDefault();
          const btn = e.target.closest('.btn-delete-invoice');
          const id = btn.dataset.id;
          console.log('Delete button clicked for ID:', id);
          if (id) {
            deleteInvoice(id);
          }
          return;
        }
      });
      
      console.log('Invoice table actions setup complete');
    }

    // Rechnung bearbeiten
    function editInvoice(id) {
      fetch(`/invoice/${id}/edit`)
        .then(response => response.json())
        .then(invoice => {
          // Modal mit Daten f√ºllen
          document.getElementById('edit-invoice-id').value = id;
          document.getElementById('edit-typ').value = invoice.typ;
          document.getElementById('edit-empfaenger').value = invoice.empfaenger;
          document.getElementById('edit-datum').value = invoice.datum;
          document.getElementById('edit-faellig').value = invoice.faellig;
          document.getElementById('edit-bemerkung').value = invoice.bemerkung || '';
          
          // Positionen laden
          const positionen = JSON.parse(invoice.positionen);
          const container = document.getElementById('edit-positionen-list');
          container.innerHTML = '';
          
          positionen.forEach(pos => {
            const row = document.createElement('div');
            row.className = 'position-row';
            row.innerHTML = `
              <input type="text" name="edit_pos_beschreibung[]" value="${pos.beschreibung}" required style="width:40%" />
              <input type="number" name="edit_pos_menge[]" value="${pos.menge}" min="1" required style="width:15%" />
              <input type="number" name="edit_pos_preis[]" value="${pos.preis}" step="0.01" min="0" required style="width:20%" />
              <button type="button" onclick="removeEditPos(this)" style="background:#ef4444; padding:8px 12px; border:none; border-radius:5px; color:#fff; cursor:pointer;">‚Äì</button>
            `;
            container.appendChild(row);
          });
          
          // Modal √∂ffnen
          openModal('edit-invoice-modal');
        })
        .catch(error => {
          console.error('Fehler beim Laden der Rechnung:', error);
          alert('Fehler beim Laden der Rechnung');
        });
    }

    // Rechnung l√∂schen
    function deleteInvoice(id) {
      if (confirm('M√∂chten Sie diese Rechnung/Angebot wirklich l√∂schen?')) {
        fetch(`/invoice/${id}/delete`, { method: 'POST' })
          .then(response => {
            if (response.ok) {
              // Zeile aus Tabelle entfernen
              const row = document.querySelector(`[data-id="${id}"]`).closest('tr');
              if (row) row.remove();
              alert('Rechnung/Angebot wurde gel√∂scht');
            } else {
              alert('Fehler beim L√∂schen');
            }
          })
          .catch(error => {
            console.error('Fehler beim L√∂schen:', error);
            alert('Fehler beim L√∂schen');
          });
      }
    }

    // Hilfsfunktionen f√ºr Bearbeiten-Modal
    function addEditPos() {
      const row = document.createElement('div');
      row.className = 'position-row';
      row.innerHTML = `
        <input type="text" name="edit_pos_beschreibung[]" placeholder="Beschreibung" required style="width:40%" />
        <input type="number" name="edit_pos_menge[]" placeholder="Menge" min="1" value="1" required style="width:15%" />
        <input type="number" name="edit_pos_preis[]" placeholder="Einzelpreis" step="0.01" min="0" required style="width:20%" />
        <button type="button" onclick="removeEditPos(this)" style="background:#ef4444; padding:8px 12px; border:none; border-radius:5px; color:#fff; cursor:pointer;">‚Äì</button>
      `;
      document.getElementById('edit-positionen-list').appendChild(row);
    }

    function removeEditPos(btn) {
      btn.parentNode.remove();
    }

    function saveEditInvoice() {
      const id = document.getElementById('edit-invoice-id').value;
      const typ = document.getElementById('edit-typ').value;
      const empfaenger = document.getElementById('edit-empfaenger').value;
      const datum = document.getElementById('edit-datum').value;
      const faellig = document.getElementById('edit-faellig').value;
      const bemerkung = document.getElementById('edit-bemerkung').value;

      // Positionen sammeln
      const beschreibungen = Array.from(document.querySelectorAll('[name="edit_pos_beschreibung[]"]')).map(e => e.value.trim());
      const mengen = Array.from(document.querySelectorAll('[name="edit_pos_menge[]"]')).map(e => e.value);
      const preise = Array.from(document.querySelectorAll('[name="edit_pos_preis[]"]')).map(e => e.value);
      
      const positionen = [];
      for (let i = 0; i < beschreibungen.length; i++) {
        if (beschreibungen[i] && mengen[i] && preise[i]) {
          positionen.push({
            beschreibung: beschreibungen[i],
            menge: mengen[i],
            preis: preise[i]
          });
        }
      }

      const data = {
        typ,
        empfaenger,
        datum,
        faellig,
        positionen: JSON.stringify(positionen),
        bemerkung
      };

      fetch(`/invoice/${id}/edit`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          alert('Rechnung/Angebot wurde gespeichert');
          closeModal('edit-invoice-modal');
          // Tabelle neu laden
          location.reload();
        } else {
          alert('Fehler beim Speichern: ' + (result.error || 'Unbekannter Fehler'));
        }
      })
      .catch(error => {
        console.error('Fehler beim Speichern:', error);
        alert('Fehler beim Speichern');
      });
    }

    // ...existing code...
    </script>
</body>
</html>